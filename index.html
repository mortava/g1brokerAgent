<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>g1brokerAgent</title>

    <!-- Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --bg: #fffffa;
        --ink: #000000;
        --border: #424242;
        --user: #424242;

        --radius-xl: 22px;
        --radius-lg: 18px;
        --radius-md: 14px;

        --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        --shadow-soft: 0 6px 18px rgba(0, 0, 0, 0.06);

        --content-max: 860px;
        --gutter: 14px;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
      }

      body {
        margin: 0;
        font-family: "Noto Sans", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        font-size: 12px;
        color: var(--ink);
        background: var(--bg);
      }

      /* App Shell */
      .app {
        min-height: 100dvh;
        display: flex;
        flex-direction: column;
        padding: calc(env(safe-area-inset-top) + 10px) var(--gutter)
          calc(env(safe-area-inset-bottom) + 12px);
        gap: 12px;
      }

      .wrap {
        width: 100%;
        max-width: var(--content-max);
        margin: 0 auto;
      }

      /* Top bar */
      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: var(--radius-xl);
        background: rgba(255, 255, 250, 0.85);
        backdrop-filter: blur(10px);
        box-shadow: var(--shadow-soft);
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 0;
      }

      .mark {
        width: 12px;
        height: 12px;
        border-radius: 4px;
        border: 1px solid var(--border);
        background: var(--bg);
        position: relative;
        flex: 0 0 auto;
      }

      .mark::after {
        content: "";
        position: absolute;
        inset: 3px;
        border-radius: 3px;
        background: var(--border);
      }

      .brand h1 {
        font-size: 12px;
        letter-spacing: 0.2px;
        margin: 0;
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .status {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        border: 1px solid var(--border);
        border-radius: 999px;
        background: var(--bg);
        line-height: 1;
        user-select: none;
      }

      .dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: var(--border);
        opacity: 0.85;
        transition: background 0.2s;
      }

      .dot.active {
        background: #22c55e;
        animation: pulse 1.5s infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      /* Chat panel */
      .panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        border: 1px solid var(--border);
        border-radius: var(--radius-xl);
        background: rgba(255, 255, 250, 0.92);
        box-shadow: var(--shadow);
        overflow: hidden;
      }

      .chat {
        flex: 1;
        overflow: auto;
        padding: 14px;
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
      }

      .messages {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      /* Message rows */
      .row {
        display: flex;
        gap: 10px;
        align-items: flex-end;
      }

      .row.user {
        justify-content: flex-end;
      }

      .row.assistant {
        justify-content: flex-start;
      }

      /* Bubbles */
      .bubble {
        max-width: min(640px, 84%);
        border-radius: var(--radius-lg);
        padding: 10px 12px;
        border: 1px solid var(--border);
        line-height: 1.5;
        box-shadow: 0 1px 0 rgba(0, 0, 0, 0.03);
        white-space: pre-wrap;
        word-break: break-word;
      }

      .row.user .bubble {
        background: var(--user);
        color: var(--bg);
        border-color: var(--border);
        border-top-right-radius: 10px;
      }

      .row.assistant .bubble {
        background: var(--bg);
        color: var(--ink);
        border-color: var(--border);
        border-top-left-radius: 10px;
      }

      .meta {
        font-size: 10px;
        opacity: 0.72;
        padding: 0 2px;
        user-select: none;
      }

      .row.user .meta {
        text-align: right;
      }

      /* Formatted content in bubbles */
      .bubble h3, .bubble h4 {
        margin: 0 0 8px 0;
        font-weight: 600;
      }
      .bubble h3 { font-size: 14px; }
      .bubble h4 { font-size: 13px; }

      .bubble p {
        margin: 0 0 8px 0;
      }
      .bubble p:last-child {
        margin-bottom: 0;
      }

      .bubble ul {
        margin: 8px 0;
        padding-left: 18px;
      }
      .bubble li {
        margin: 4px 0;
      }

      .bubble table {
        width: 100%;
        border-collapse: collapse;
        margin: 10px 0;
        font-size: 11px;
      }
      .bubble th, .bubble td {
        border: 1px solid var(--border);
        padding: 6px 8px;
        text-align: left;
      }
      .bubble th {
        background: rgba(66, 66, 66, 0.08);
        font-weight: 600;
      }
      .bubble tr:nth-child(even) td {
        background: rgba(66, 66, 66, 0.03);
      }

      .bubble strong {
        font-weight: 600;
      }

      /* Thinking indicator */
      .thinking {
        display: flex;
        gap: 4px;
        padding: 8px 12px;
      }

      .thinking span {
        width: 6px;
        height: 6px;
        background: var(--border);
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out;
      }

      .thinking span:nth-child(1) { animation-delay: 0s; }
      .thinking span:nth-child(2) { animation-delay: 0.2s; }
      .thinking span:nth-child(3) { animation-delay: 0.4s; }

      @keyframes bounce {
        0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
        40% { transform: scale(1); opacity: 1; }
      }

      /* Welcome / Landing State */
      .welcome-state .chat {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      .welcome-state .messages {
        display: none;
      }

      .welcome-state .composer {
        border-top: none;
        background: transparent;
        width: 100%;
        max-width: 540px;
      }

      .welcome-greeting {
        text-align: center;
        margin-bottom: 24px;
        padding: 0 20px;
      }

      .welcome-greeting h2 {
        font-size: 20px;
        font-weight: 600;
        margin: 0;
        color: var(--ink);
      }

      .chat-state .welcome-greeting {
        display: none;
      }

      .chat-state .composer {
        max-width: none;
      }

      /* Composer */
      .composer {
        border-top: 1px solid rgba(66, 66, 66, 0.25);
        padding: 10px;
        background: rgba(255, 255, 250, 0.98);
        transition: all 0.3s ease;
      }

      .composerForm {
        display: flex;
        align-items: flex-end;
        gap: 10px;
        border: 1px solid var(--border);
        border-radius: var(--radius-xl);
        padding: 10px 10px;
        background: var(--bg);
      }

      .prompt {
        flex: 1;
        resize: none;
        border: none;
        outline: none;
        background: transparent;
        color: var(--ink);
        font-family: inherit;
        font-size: 12px;
        line-height: 1.35;
        min-height: 18px;
        max-height: 160px;
        overflow: auto;
        padding: 0;
        margin: 0;
      }

      .prompt::placeholder {
        color: rgba(0, 0, 0, 0.55);
      }

      .send {
        flex: 0 0 auto;
        width: 40px;
        height: 40px;
        border-radius: 14px;
        border: 1px solid var(--border);
        background: var(--bg);
        color: var(--ink);
        cursor: pointer;
        display: grid;
        place-items: center;
        transition: transform 120ms ease, box-shadow 120ms ease;
        box-shadow: 0 1px 0 rgba(0, 0, 0, 0.03);
      }

      .send:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 18px rgba(0, 0, 0, 0.08);
      }

      .send:active {
        transform: translateY(0px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.06);
      }

      .send[disabled] {
        opacity: 0.45;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .hint {
        margin-top: 8px;
        display: flex;
        justify-content: space-between;
        gap: 10px;
        opacity: 0.7;
        font-size: 10px;
        user-select: none;
      }

      .kbd {
        border: 1px solid rgba(66, 66, 66, 0.55);
        border-bottom-width: 2px;
        padding: 1px 6px;
        border-radius: 8px;
        background: rgba(255, 255, 250, 0.7);
      }

      /* Mobile polish */
      @media (max-width: 520px) {
        :root {
          --gutter: 10px;
        }
        .chat {
          padding: 12px;
        }
        .bubble {
          max-width: 88%;
        }
      }

      @media (prefers-reduced-motion: reduce) {
        .chat {
          scroll-behavior: auto;
        }
        .send {
          transition: none;
        }
      }
    </style>
  </head>

  <body>
    <div class="app">
      <div class="wrap">
        <header class="topbar" aria-label="Header">
          <div class="brand">
            <span class="mark" aria-hidden="true"></span>
            <h1>g1brokerAgent</h1>
          </div>

          <div class="status" aria-label="Status">
            <span class="dot" id="statusDot" aria-hidden="true"></span>
            <span id="statusText">Ready</span>
          </div>
        </header>
      </div>

      <div class="wrap panel welcome-state" id="panel" role="application" aria-label="Chat panel">
        <main class="chat" id="chat" aria-label="Conversation">
          <div class="welcome-greeting" id="welcomeGreeting">
            <h2>Hello, I'm your Mortgage Assistant.</h2>
          </div>
          <div class="messages" id="messages"></div>
        </main>

        <footer class="composer" aria-label="Message composer">
          <form class="composerForm" id="composerForm" autocomplete="off">
            <textarea
              id="prompt"
              class="prompt"
              rows="1"
              placeholder="Ask me anything about your current or a new mortgage..."
              aria-label="Message input"
            ></textarea>

            <button id="sendBtn" class="send" type="submit" aria-label="Send message" disabled>
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M5 12h12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M13 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </form>

          <div class="hint" aria-hidden="true">
            <span><span class="kbd">Enter</span> send</span>
            <span><span class="kbd">Shift</span> + <span class="kbd">Enter</span> new line</span>
          </div>
        </footer>
      </div>
    </div>

    <script>
      const PROXY_URL = '/api/chat';
      const messagesEl = document.getElementById("messages");
      const chatEl = document.getElementById("chat");
      const formEl = document.getElementById("composerForm");
      const promptEl = document.getElementById("prompt");
      const sendBtn = document.getElementById("sendBtn");
      const statusDot = document.getElementById("statusDot");
      const statusText = document.getElementById("statusText");
      const panelEl = document.getElementById("panel");

      let conversationHistory = [];
      let chatStarted = false;

      const startChat = () => {
        if (chatStarted) return;
        chatStarted = true;
        panelEl.classList.remove('welcome-state');
        panelEl.classList.add('chat-state');
        promptEl.placeholder = "Type a message...";
      };

      const autoGrow = (el) => {
        el.style.height = "0px";
        const next = Math.min(el.scrollHeight, 160);
        el.style.height = next + "px";
        el.style.overflowY = el.scrollHeight > 160 ? "auto" : "hidden";
      };

      const setSendEnabled = (enabled) => {
        const hasText = promptEl.value.trim().length > 0;
        sendBtn.disabled = !hasText || !enabled;
      };

      const scrollToBottom = () => {
        chatEl.scrollTop = chatEl.scrollHeight;
      };

      const setStatus = (text, active = false) => {
        statusText.textContent = text;
        statusDot.classList.toggle('active', active);
      };

      const escapeHtml = (str) =>
        str
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");

      const convertMarkdownTables = (text) => {
        const tableRegex = /\|(.+)\|\n\|[-|\s]+\|\n((?:\|.+\|\n?)+)/g;

        return text.replace(tableRegex, (match, headerRow, bodyRows) => {
          const headers = headerRow.split('|').map(h => h.trim()).filter(h => h);
          const rows = bodyRows.trim().split('\n');

          let table = '<table><thead><tr>';
          headers.forEach(h => {
            table += `<th>${escapeHtml(h)}</th>`;
          });
          table += '</tr></thead><tbody>';

          rows.forEach(row => {
            const cells = row.split('|').map(c => c.trim()).filter(c => c);
            table += '<tr>';
            cells.forEach(c => {
              table += `<td>${escapeHtml(c)}</td>`;
            });
            table += '</tr>';
          });
          table += '</tbody></table>';
          return table;
        });
      };

      const formatResponse = (text) => {
        if (!text) return 'No response received';

        let formatted = escapeHtml(text);

        // Convert markdown headers
        formatted = formatted.replace(/^### (.*$)/gm, '<h4>$1</h4>');
        formatted = formatted.replace(/^## (.*$)/gm, '<h3>$1</h3>');

        // Convert **bold** to <strong>
        formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

        // Convert *italic* to <em>
        formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');

        // Convert markdown tables to HTML (need to unescape for table parsing)
        formatted = convertMarkdownTables(formatted.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&'));

        // Convert bullet points
        formatted = formatted.replace(/^- (.*$)/gm, '<li>$1</li>');
        formatted = formatted.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');

        // Convert line breaks
        formatted = formatted.replace(/\n\n/g, '</p><p>');
        formatted = formatted.replace(/\n/g, '<br>');

        // Wrap in paragraph if not already structured
        if (!formatted.startsWith('<')) {
          formatted = '<p>' + formatted + '</p>';
        }

        return formatted;
      };

      const addMessage = (role, text) => {
        // Remove thinking indicator if present
        const thinking = document.getElementById('thinkingRow');
        if (thinking) thinking.remove();

        const row = document.createElement("div");
        row.className = `row ${role}`;

        const outer = document.createElement("div");
        const bubble = document.createElement("div");
        bubble.className = "bubble";

        // Format assistant responses, escape user input
        if (role === "assistant") {
          bubble.innerHTML = formatResponse(text);
        } else {
          bubble.textContent = text;
        }

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent = role === "user" ? "You" : "Assistant";

        outer.appendChild(bubble);
        outer.appendChild(meta);
        row.appendChild(outer);
        messagesEl.appendChild(row);

        scrollToBottom();
      };

      const showThinking = () => {
        const row = document.createElement("div");
        row.className = "row assistant";
        row.id = "thinkingRow";

        const outer = document.createElement("div");
        const bubble = document.createElement("div");
        bubble.className = "bubble thinking";
        bubble.innerHTML = '<span></span><span></span><span></span>';

        outer.appendChild(bubble);
        row.appendChild(outer);
        messagesEl.appendChild(row);

        scrollToBottom();
      };

      const sendMessage = async (text) => {
        startChat();
        addMessage("user", text);
        conversationHistory.push({ role: 'user', content: text });

        showThinking();
        setStatus('Thinking...', true);
        setSendEnabled(false);

        try {
          const res = await fetch(PROXY_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              message: text,
              conversationHistory: conversationHistory,
              lastFormValues: {},
              enableCaching: true
            }),
          });

          if (!res.ok) throw new Error("Request failed");

          const data = await res.json();
          const responseText = data.response || data.message || JSON.stringify(data);

          conversationHistory.push({ role: 'assistant', content: responseText });
          addMessage("assistant", responseText);

        } catch (err) {
          addMessage("assistant", "Sorry, something went wrong. Please try again.");
        }

        setStatus('Ready', false);
        setSendEnabled(true);
        promptEl.focus();
      };

      promptEl.addEventListener("input", () => {
        autoGrow(promptEl);
        setSendEnabled(true);
      });

      promptEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          if (!sendBtn.disabled) formEl.requestSubmit();
        }
      });

      formEl.addEventListener("submit", async (e) => {
        e.preventDefault();
        const text = promptEl.value.trim();
        if (!text) return;

        promptEl.value = "";
        autoGrow(promptEl);
        setSendEnabled(false);

        await sendMessage(text);
      });

      // Initialize
      autoGrow(promptEl);
      setSendEnabled(true);
    </script>
  </body>
</html>
